generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Project {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  name      String
  lead      String?
  type      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  overview       ProjectOverview?
  worklogs       Worklog[] // Keep worklogs separate for now as they can be numerous
  stakeholders   Stakeholder[]
  quickLinks     QuickLink[]
  savedFilters   SavedFilter[]
}

type ProjectOverview {
  schdHealth      String   @default("yellow")
  complexity      String   @default("Medium")
  projectType     String?
  projectStatus   String?
  planStartDate     String?
  planEndDate       String?
  percentComplete   String?
  clientLocation    String?
  currentPhase      String?
  bpwTargetMargin   String?

  // Data Blobs
  budget          Json?
  health          Json?
}

type Stakeholder {
  id              String
  role            String
  accountId       String?
  displayName     String?
  avatarUrl       String?
}

type QuickLink {
  id        String
  name      String
  url       String
}

type SavedFilter {
  id          String
  name        String
  jql         String
  description String?
}

model Worklog {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  jiraWorklogId    String   @unique // External ID from Jira
  issueKey         String
  issueSummary     String?
  authorAccountId  String
  authorDisplayName String
  authorAvatarUrl  String?
  timeSpent        String
  timeSpentSeconds Int
  started          DateTime
  comment          String?
  
  projectId        String   @db.ObjectId
  project          Project  @relation(fields: [projectId], references: [id])

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// Resource Allocation tracking for capacity planning
model ResourceAllocation {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  projectKey        String
  accountId         String   // Jira user account ID
  displayName       String
  avatarUrl         String?
  startDate         String   // YYYY-MM-DD
  endDate           String   // YYYY-MM-DD
  allocationPercent Int      // 0-200 (percentage)
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([projectKey, accountId])
  @@index([projectKey, startDate, endDate])
}

// Weekly capacity snapshots for historical tracking
model CapacitySnapshot {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  projectKey  String
  weekStart   String   // Monday of the week (YYYY-MM-DD)
  
  // Snapshot data stored as JSON for flexibility
  teamCapacity Json    // Array of { accountId, displayName, plannedAllocation, actualHours, availableHours, utilizationPercent, status }
  
  createdAt   DateTime @default(now())

  @@index([projectKey, weekStart])
}
